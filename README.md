# uniffi-dl

*uniffi-dl* is a plugin designed for the IntelliJ IDE (and its different flavours, such as Android Studio)
with the goal to provide syntax highlighting, code folding, code completion, reference resolution and navigation,
among other features such as offering view of the code structure or handy quick fixes.

# Contributing

The first thing to do is to download and install [`git`][git], [IntelliJ IDEA][intellij], and the required plugins
for the IDE: *Plugin DevKit*, *Gradle* (both of which should be on by default), and additionally
[*Grammar-Kit*][grammar-kit] and [*PsiViewer*][psi-viewer] which can be downloaded from within the IDE.

[git]: https://www.git-scm.com/

[intellij]: https://www.jetbrains.com/idea/download/

[grammar-kit]: https://plugins.jetbrains.com/plugin/6606-grammar-kit

[psi-viewer]: https://plugins.jetbrains.com/plugin/227-psiviewer

## Building

Before building, the grammar must be used to generate the required types and parsing code.

Right-click `src/main/kotlin/dev/lonami/uniffidl/Udl.bnf` and select "Generate Parser Code".

Right-click `src/main/kotlin/dev/lonami/uniffidl/Udl.flex` and select "Run JFlex Generator".
During the first run you will have to select the root of the project itself to download
both `idea-flex.skeleton` and `jflex*.jar`.

Then it should be possible to run `gradlew buildPlugin` or `gradlew runIde`, or by clicking on the "Play"
button of the IDE to run the selected Gradle configuration.

## Project Structure

Nearly every file, class or interface uses `Udl` as the prefix.

### Base Definitions

* The custom language singleton instance is defined in `UdlLanguage`.
* The `.udl` file type is associated with the language via `UdlFileType`.
* Icons such as the one used for the `.udl` files are in `UdlIcons`.

### Grammar

* Leaf grammar tokens are instances of `psi.UdlTokenType`, which are associated with the language.
* Intermediate grammar rules are instances of `psi.UdlElementType`, also linked to the language.
* The grammar description, mostly ported from WebIDL, is in the `Udl.bnf` file.
* The lexer description, consisting of a few core regular expressions and tokens, is in the `Udl.flex` file.
* `UdlLexerAdapter` is an auxiliary class for the IDE to be able to initialize the generated `UdlLexer`.
* `psi.UdlTokenSets` is used to define the groups a token belongs to.

### AST

* `psi.UdlFile` is the root of the parsed tree of `PsiElement`.
* `UdlParserDefinition` is what creates the parser, lexer, and root nodes for the language.
* The rest of nodes are autogenerated. Some of these contain additional, handwritten methods,
  which are defined in `psi.impl.UdlPsiImplUtil`, as referenced to in the `.bnf`. To provide
  other features such as resolving references and navigation, they must also implement
  `psi.UdlNamedElement` and `psi.impl.UdlNamedElementImpl`.
* `UdlUtil` contains several methods to make working with the AST easier.
* `psi.UdlElementFactory` simplifies the process of creating AST nodes outside of parsing.

### Features

* Folding of blocks is provided by `UdlFoldingBuilder`.
* Syntax highlighting based on the tokens is provided by `UdlSyntaxHighlighter`.
  The `UdlSyntaxHighlighterFactory` is necessary for the IDE to create an instance of the highlighter.
  A [custom Color Settings Page could be defined][color-settings] but is not currently implemented.
* Annotations are provided by the `UdlAnnotator`, which can provide more fine-tuned syntax highlighting
  based on the AST, as well as underlining errors and offering quick fixes. These quick, such as
  `UdlCreateDictionaryQuickFix`, are defined by implementing "intention actions".
* Line markers to help highlight the type of definitions via gutter icons and provide additional features
  such as quick navigation is currently not implemented, but a [custom Line Marker Provider][line-marker]
  could also be defined.
* Code completion is provided by `UdlCompletionContributor`.
* The commenter is defined by `UdlCommenter`, which simply defines the comment markers used by the language.
* Reference resolution is provided by `UdlReferenceContributor`, which returns instances of `UdlReference` in order
  to perform the actual resolution. [Support for in-place refactoring could be defined][inplace-refactor] but is not
  currently implemented.
* Find usages is provided by `UdlFindUsagesProvider`, while navigate to symbol is provided by
  `UdlChooseByNameContributor` for those elements which can `getPresentation`.
* Code structure is provided by `UdlStructureViewFactory`, which simply returns the `UdlStructureViewModel`.
  The view model returns an instance of `UdlStructureViewElement` with the root node of the AST. For the
  navigation bar to be aware of the structure, `UdlStructureAwareNavBar` is used instead.
* Automatic formatting is done by defining `UdlBlock` which is used to wrap the AST in a way that can be formatted.
  The `UdlFormattingModelBuilder` is used to create the first instance of the `UdlBlock` and define spacing rules.
  Similar to a color settings page, [a Code Style Settings page could be defined][code-settings], but is not currently
  implemented
* Both hover and quick documentation is provided by the `UdlDocumentationProvider`

[color-settings]: https://plugins.jetbrains.com/docs/intellij/syntax-highlighter-and-color-settings-page.html#define-a-color-settings-page

[line-marker]: https://plugins.jetbrains.com/docs/intellij/line-marker-provider.html#define-a-line-marker-provider

[inplace-refactor]: https://plugins.jetbrains.com/docs/intellij/reference-contributor.html#define-a-refactoring-support-provider

[code-settings]: https://plugins.jetbrains.com/docs/intellij/code-style-settings.html#define-code-style-settings
